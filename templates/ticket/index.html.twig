{# Template pour afficher la liste de tous les tickets #}
{% extends 'base.html.twig' %}

{% block title %}Liste des tickets{% endblock %}

{% block body %}
<div class="container-fluid">
    {# En-tête de la page #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-ticket-detailed-fill text-primary"></i>
            {% if is_granted('ROLE_TECHNICIEN') %}
                Tous les tickets
            {% else %}
                Mes tickets
            {% endif %}
        </h1>
        
        <a href="{{ path('app_ticket_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Créer un nouveau ticket
        </a>
    </div>

    {# Filtres rapides (optionnels) #}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" data-filter="all">
                    Tous ({{ tickets|length }})
                </button>
                <button type="button" class="btn btn-outline-primary" data-filter="ouvert">
                    Ouverts
                </button>
                <button type="button" class="btn btn-outline-warning" data-filter="en_cours">
                    En cours
                </button>
                <button type="button" class="btn btn-outline-success" data-filter="resolu">
                    Résolus
                </button>
            </div>
        </div>
    </div>

    {# Affichage des tickets sous forme de cartes #}
    {% if tickets|length > 0 %}
        <div class="row">
            {% for ticket in tickets %}
                <div class="col-md-6 col-lg-4 mb-4" data-statut="{{ ticket.statut }}">
                    <div class="card ticket-card h-100 shadow-sm">
                        {# En-tête de la carte avec priorité #}
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="{{ ticket.prioriteBadgeClass }}">
                                <i class="bi bi-exclamation-triangle"></i>
                                {{ ticket.priorite|upper }}
                            </span>
                            <small class="text-muted">#{{ ticket.id }}</small>
                        </div>
                        
                        {# Corps de la carte #}
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="{{ path('app_ticket_show', {'id': ticket.id}) }}" class="text-decoration-none">
                                    {{ ticket.titre }}
                                </a>
                            </h5>
                            
                            <p class="card-text text-muted">
                                {{ ticket.description|length > 100 ? ticket.description|slice(0, 100) ~ '...' : ticket.description }}
                            </p>
                            
                            {# Informations du ticket #}
                            <div class="mb-2">
                                <span class="{{ ticket.statutBadgeClass }}">
                                    {{ ticket.statut|replace({'_': ' '})|title }}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-folder"></i> {{ ticket.categorie|title }}
                                </span>
                            </div>
                            
                            {# Informations sur le créateur et le technicien #}
                            <div class="small text-muted mt-3">
                                <div>
                                    <i class="bi bi-person"></i>
                                    Créé par: <strong>{{ ticket.createur.nomComplet }}</strong>
                                </div>
                                
                                {% if ticket.technicien %}
                                    <div>
                                        <i class="bi bi-wrench"></i>
                                        Assigné à: <strong>{{ ticket.technicien.nomComplet }}</strong>
                                    </div>
                                {% else %}
                                    <div class="text-warning">
                                        <i class="bi bi-exclamation-circle"></i>
                                        Non assigné
                                    </div>
                                {% endif %}
                                
                                <div class="mt-2">
                                    <i class="bi bi-calendar"></i>
                                    {{ ticket.dateCreation|date('d/m/Y à H:i') }}
                                </div>
                            </div>
                        </div>
                        
                        {# Pied de carte avec actions #}
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between">
                                <a href="{{ path('app_ticket_show', {'id': ticket.id}) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Voir
                                </a>
                                
                                {# Boutons d'action selon les droits #}
                                {% if ticket.createur == app.user and ticket.statut == 'ouvert' %}
                                    <a href="{{ path('app_ticket_edit', {'id': ticket.id}) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-pencil"></i> Modifier
                                    </a>
                                {% endif %}
                                
                                {# Bouton d'assignation pour les techniciens #}
                                {% if is_granted('ROLE_TECHNICIEN') and not ticket.technicien %}
                                    <form method="post" action="{{ path('app_ticket_assign', {'id': ticket.id}) }}" class="d-inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('assign' ~ ticket.id) }}">
                                        <button class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-person-check"></i> M'assigner
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {# Message si aucun ticket #}
        <div class="alert alert-info text-center" role="alert">
            <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
            <h4>Aucun ticket pour le moment</h4>
            <p>Vous n'avez pas encore créé de ticket. Cliquez sur le bouton ci-dessus pour en créer un.</p>
            <a href="{{ path('app_ticket_new') }}" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle"></i> Créer mon premier ticket
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Script pour filtrer les tickets par statut
        document.querySelectorAll('[data-filter]').forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                // Mise à jour des boutons actifs
                document.querySelectorAll('[data-filter]').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // Filtrage des tickets
                document.querySelectorAll('[data-statut]').forEach(card => {
                    if (filter === 'all' || card.dataset.statut === filter) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
    </script>
{% endblock %}
